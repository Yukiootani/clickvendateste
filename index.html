<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="config.js"></script>

    <style>
        :root { --primary: #333; --accent: #Cca43b; --bg: #FDFBF7; --text: #333; }
        body { margin:0; font-family:'Montserrat',sans-serif; background:var(--bg); color:var(--text); padding-bottom:100px; }
        
        #loader { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:99999; display:flex; justify-content:center; align-items:center; }
        
        header { background:white; padding:20px; text-align:center; border-bottom:3px solid var(--accent); }
        .cms-logo { max-height:100px; display:block; margin:0 auto; }
        
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; padding:0 15px; max-width:800px; margin:0 auto; }
        .card { background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.05); text-decoration:none; color:inherit; }
        .card img { width:100%; height:160px; object-fit:cover; }
        .info { padding:10px; text-align:center; }
        
        /* Marca D'agua de Versão */
        .version-tag { background: red; color: white; text-align: center; font-weight: bold; padding: 5px; }
    </style>
</head>
<body>
    
    <div class="version-tag">VERSÃO FINAL 5.0 (Se ver isso, atualizou)</div>

    <div id="loader">Carregando...</div>

    <header>
        <img src="" class="cms-logo" alt="Logo">
        <h3 id="cms-title">Loja</h3>
    </header>

    <div class="grid" id="products"></div>

    <script>
        // --- CÓDIGO IDÊNTICO AO QUE FUNCIONOU NO DEBUG ---
        
        if (!firebase.apps.length) firebase.initializeApp(SETUP.firebase);
        const db = firebase.firestore();

        async function loadP() {
            const g = document.getElementById('products');
            try {
                // Força limpar cache do Service Worker antigo
                if(window.navigator && navigator.serviceWorker) {
                    navigator.serviceWorker.getRegistrations().then( function(registrations) { for(let registration of registrations) { registration.unregister(); } });
                }

                const s = await db.collection('products').get();
                
                g.innerHTML = ''; 
                
                if (s.empty) {
                    g.innerHTML = '<p style="padding:20px; text-align:center">Sem produtos.</p>';
                }

                s.forEach(doc => {
                    const p = doc.data();
                    const img = p.imageUrl || 'https://via.placeholder.com/150';
                    g.innerHTML += `
                    <a href="detalhes.html?id=${doc.id}" class="card">
                        <img src="${img}">
                        <div class="info">
                            <div>${p.name}</div>
                            <b>¥ ${p.price}</b>
                        </div>
                    </a>`;
                });
                
                document.getElementById('loader').style.display = 'none';

            } catch (error) {
                alert("Erro: " + error.message);
                document.getElementById('loader').style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadP);
    </script>
</body>
</html>
