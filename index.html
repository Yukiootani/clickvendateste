<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja DEBUG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="config.js"></script>

    <style>
        /* Estilos CMS */
        :root { --primary: #333; --accent: #Cca43b; --bg: #FDFBF7; --text: #333; }
        body { margin:0; font-family:'Montserrat',sans-serif; background:var(--bg); color:var(--text); padding-bottom:100px; }
        
        /* Loader */
        #loader { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; transition: opacity 0.5s; }
        
        /* Debug Box (Caixa Preta de Erros) */
        #debug-log { background: black; color: #0f0; padding: 10px; font-family: monospace; margin: 10px; border-radius: 5px; font-size: 12px; display: none; }

        header { background:white; padding:20px; text-align:center; border-bottom:3px solid var(--accent); }
        .cms-logo { max-height:100px; display:block; margin:0 auto; }
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; padding:15px; }
        .card { background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.05); text-decoration:none; color:inherit; }
        .card img { width:100%; height:160px; object-fit:cover; }
        .info { padding:10px; text-align:center; }
    </style>
</head>
<body>

    <div id="loader">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p>Carregando Loja...</p>
        <button onclick="forceCloseLoader()" style="margin-top:20px; padding:10px;">Forçar Entrada</button>
    </div>

    <div id="debug-log">LOG DE ERROS:<br></div>

    <header>
        <img src="" class="cms-logo" alt="Logo">
        <div id="cms-slogan">Slogan da Loja</div>
    </header>

    <div class="grid" id="products"></div>

    <script>
        // --- FUNÇÃO PARA ESCREVER ERRO NA TELA ---
        function log(msg) {
            const box = document.getElementById('debug-log');
            box.style.display = 'block';
            box.innerHTML += `> ${msg}<br>`;
            console.log(msg);
        }

        // --- 1. INICIALIZAÇÃO ---
        log("Iniciando script...");
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(SETUP.firebase);
                log("Firebase Conectado.");
            }
        } catch(e) {
            log("ERRO FATAL NO FIREBASE: " + e.message);
        }

        const db = firebase.firestore();

        // --- 2. CARREGAR PRODUTOS ---
        async function loadProducts() {
            log("Buscando produtos no banco...");
            const grid = document.getElementById('products');

            try {
                // Busca simples, sem ordenação para evitar travas
                const snapshot = await db.collection('products').get();
                
                log(`Busca concluída. Encontrados: ${snapshot.size} produtos.`);

                if (snapshot.empty) {
                    grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Nenhum produto na coleção "products".</p>';
                    // Se estiver vazio, remove o loader mesmo assim
                    document.getElementById('loader').style.display = 'none';
                    return;
                }

                grid.innerHTML = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    log(`Renderizando: ${p.name}`); // Avisa qual produto achou
                    
                    // Garante imagem
                    let img = p.imageUrl;
                    if(!img || img.trim() === "") img = "https://via.placeholder.com/300?text=Sem+Foto";

                    grid.innerHTML += `
                    <a href="detalhes.html?id=${doc.id}" class="card">
                        <img src="${img}" onerror="this.src='https://via.placeholder.com/300?text=Erro+Img'">
                        <div class="info">
                            <b>${p.name}</b><br>
                            ¥ ${p.price}
                        </div>
                    </a>`;
                });

                // TUDO CERTO? Some com o Loader
                document.getElementById('loader').style.display = 'none';

            } catch (error) {
                log("ERRO AO BUSCAR PRODUTOS: " + error.message);
                if(error.message.includes("indexes")) {
                    log("ALERTA: O Firebase pediu para criar índice. Veja o Console (F12).");
                }
                // Se der erro, o loader some para mostrar o erro
                document.getElementById('loader').style.display = 'none';
            }
        }

        // --- 3. FORÇAR SAÍDA DO LOADER ---
        function forceCloseLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // Inicia
        document.addEventListener('DOMContentLoaded', loadProducts);
        
        // Aplica o tema visual se der certo
        try {
            if(typeof applyCMS === 'function') applyCMS();
        } catch(e) { log("Aviso: CMS visual não carregou, usando padrão."); }

    </script>
</body>
</html>
