<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #333; --accent: #888; --bg: #eee; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        h3 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top:0; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .theme-opt { display: inline-block; width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; cursor: pointer; border: 2px solid #ddd; }
        .theme-opt.selected { border-color: black; transform: scale(1.2); }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <a href="manager.html" style="text-decoration:none; color:#333;"><i class="fas fa-arrow-left"></i> Voltar</a>
        <strong>Painel CMS</strong>
    </div>
    <div class="card">
        <h3>ðŸŽ¨ AparÃªncia</h3>
        <div id="theme-selector" style="margin: 10px 0;">
            <div class="theme-opt" style="background:#1B263B" onclick="setTheme('padrao', this)"></div>
            <div class="theme-opt" style="background:#be185d" onclick="setTheme('rosa', this)"></div>
            <div class="theme-opt" style="background:#1e3a8a" onclick="setTheme('azul', this)"></div>
            <div class="theme-opt" style="background:#000000" onclick="setTheme('preto', this)"></div>
        </div>
        <input type="hidden" id="theme-val" value="padrao">
        <input id="cms-slogan-in" placeholder="Slogan">
        <input id="cms-headline-in" placeholder="TÃ­tulo Principal">
        <input id="cms-sub-in" placeholder="SubtÃ­tulo">
        <label>Logo:</label><input type="file" id="cms-logo-in">
        <button onclick="saveLayout()">SALVAR APARÃŠNCIA</button>
    </div>
    <div class="card">
        <h3>ðŸ“¦ Novo Produto</h3>
        <input id="p-name" placeholder="Nome">
        <input id="p-price" type="number" placeholder="PreÃ§o">
        <input type="file" id="p-img">
        <button onclick="saveProduct()">CADASTRAR</button>
    </div>
    <div class="card" style="border:1px solid #Cca43b">
        <h3 style="color:#Cca43b">ðŸ”” Push Notification</h3>
        <input id="push-title" placeholder="TÃ­tulo">
        <textarea id="push-msg" placeholder="Mensagem"></textarea>
        <button onclick="sendPush()" style="background:#Cca43b">ENVIAR</button>
    </div>
    <script>
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.onAuthStateChanged(u => { if(!u) location.href='manager.html'; else loadData(); });
        async function upload(file) {
            const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', SETUP.cloudinary.uploadPreset);
            const r = await fetch(`https://api.cloudinary.com/v1_1/${SETUP.cloudinary.cloudName}/image/upload`, {method:'POST', body:fd});
            return (await r.json()).secure_url;
        }
        function setTheme(name, el) {
            document.getElementById('theme-val').value = name;
            document.querySelectorAll('.theme-opt').forEach(d=>d.classList.remove('selected'));
            el.classList.add('selected');
        }
        async function loadData() {
            const doc = await db.collection('cms').doc('layout').get();
            if(doc.exists) {
                const d = doc.data();
                document.getElementById('cms-slogan-in').value = d.slogan||'';
                document.getElementById('cms-headline-in').value = d.headline||'';
                document.getElementById('cms-sub-in').value = d.subheadline||'';
                document.getElementById('theme-val').value = d.theme||'padrao';
            }
        }
        async function saveLayout() {
            const file = document.getElementById('cms-logo-in').files[0];
            let logoUrl = null;
            if(file) logoUrl = await upload(file);
            const data = { theme: document.getElementById('theme-val').value, slogan: document.getElementById('cms-slogan-in').value, headline: document.getElementById('cms-headline-in').value, subheadline: document.getElementById('cms-sub-in').value };
            if(logoUrl) data.logoUrl = logoUrl;
            await db.collection('cms').doc('layout').set(data, {merge:true});
            alert("âœ… Salvo!");
        }
        async function saveProduct() {
            const img = await upload(document.getElementById('p-img').files[0]);
            await db.collection('products').add({ name: document.getElementById('p-name').value, price: Number(document.getElementById('p-price').value), imageUrl: img, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            alert("Produto Salvo!");
        }
        async function sendPush() {
            const t = document.getElementById('push-title').value;
            const m = document.getElementById('push-msg').value;
            if(confirm("Enviar?")) {
                await fetch('/.netlify/functions/send-push', { method:'POST', body:JSON.stringify({title:t, body:m}) });
                alert("Enviado!");
            }
        }
    </script>
</body>
</html>