<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #333; --accent: #888; --bg: #eee; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h3 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top:0; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-top: 10px; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 15px; }
        button:hover { opacity: 0.9; }
        
        .theme-opt { display: inline-block; width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; cursor: pointer; border: 2px solid #ddd; }
        .theme-opt.selected { border-color: black; transform: scale(1.2); }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
        <a href="manager.html" style="text-decoration:none; color:#333;"><i class="fas fa-arrow-left"></i> Voltar</a>
        <strong>Painel CMS 2.0</strong>
    </div>

    <div class="card">
        <h3>ðŸŽ¨ AparÃªncia da Loja</h3>
        <label>Cor do Tema:</label>
        <div id="theme-selector" style="margin: 10px 0;">
            <div class="theme-opt" style="background:#1B263B" onclick="setTheme('padrao', this)"></div>
            <div class="theme-opt" style="background:#be185d" onclick="setTheme('rosa', this)"></div>
            <div class="theme-opt" style="background:#1e3a8a" onclick="setTheme('azul', this)"></div>
            <div class="theme-opt" style="background:#000000" onclick="setTheme('preto', this)"></div>
        </div>
        <input type="hidden" id="theme-val" value="padrao">

        <input id="cms-headline-in" placeholder="TÃ­tulo Principal (Ex: Loja do Yukio)">
        <input id="cms-slogan-in" placeholder="Slogan (Ex: O Melhor PreÃ§o)">
        <button onclick="saveLayout()">SALVAR APARÃŠNCIA</button>
    </div>

    <div class="card">
        <h3>ðŸ“¦ Novo Produto Completo</h3>
        
        <label>Nome:</label>
        <input id="p-name" placeholder="Ex: TÃªnis Esportivo">
        
        <label>PreÃ§o (Â¥):</label>
        <input id="p-price" type="number" placeholder="0">
        
        <label>DescriÃ§Ã£o Detalhada:</label>
        <textarea id="p-desc" rows="3" placeholder="Descreva o produto..."></textarea>

        <label style="color:#d97706">1. Foto de Capa (ObrigatÃ³rio):</label>
        <input type="file" id="p-img">

        <label style="color:#2563eb">2. Galeria de Fotos (Opcional - Selecione vÃ¡rias):</label>
        <input type="file" id="p-gallery" multiple>

        <label style="color:#dc2626">3. VÃ­deo do Produto (Opcional - Max 30s):</label>
        <input type="file" id="p-video" accept="video/*">

        <button onclick="saveProduct()" id="btn-save-prod">CADASTRAR PRODUTO</button>
        <p id="status-msg" style="text-align:center; color:#666; font-size:0.8em; margin-top:5px;"></p>
    </div>

    <script>
        if (!firebase.apps.length) firebase.initializeApp(SETUP.firebase);
        const db = firebase.firestore();
        const auth = firebase.auth();

        auth.onAuthStateChanged(u => { if(!u) location.href='manager.html'; else loadData(); });

        // --- FUNÃ‡ÃƒO UPLOAD INTELIGENTE (FOTO E VÃDEO) ---
        async function upload(file) {
            if(!file) return null;
            
            // Define se Ã© imagem ou video para a API correta
            const type = file.type.includes('video') ? 'video' : 'image';
            
            const fd = new FormData(); 
            fd.append('file', file); 
            fd.append('upload_preset', SETUP.cloudinary.uploadPreset);
            
            // AtenÃ§Ã£o: Muda a URL dependendo do tipo
            const req = await fetch(`https://api.cloudinary.com/v1_1/${SETUP.cloudinary.cloudName}/${type}/upload`, {
                method:'POST', 
                body:fd
            });
            const resp = await req.json();
            return resp.secure_url;
        }

        // --- SALVAR PRODUTO ---
        async function saveProduct() {
            const btn = document.getElementById('btn-save-prod');
            const status = document.getElementById('status-msg');
            
            // ValidaÃ§Ã£o simples
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const coverFile = document.getElementById('p-img').files[0];

            if(!name || !price || !coverFile) return alert("Preencha Nome, PreÃ§o e Foto de Capa!");

            try {
                btn.disabled = true;
                btn.innerText = "â³ Enviando Capa...";
                
                // 1. Upload da Capa
                const coverUrl = await upload(coverFile);

                // 2. Upload da Galeria (Loop)
                const galleryFiles = document.getElementById('p-gallery').files;
                let galleryUrls = [];
                if(galleryFiles.length > 0) {
                    btn.innerText = `â³ Enviando ${galleryFiles.length} fotos extras...`;
                    // Envia todas em paralelo
                    const promises = Array.from(galleryFiles).map(file => upload(file));
                    galleryUrls = await Promise.all(promises);
                }

                // 3. Upload do VÃ­deo
                const videoFile = document.getElementById('p-video').files[0];
                let videoUrl = null;
                if(videoFile) {
                    btn.innerText = "â³ Enviando VÃ­deo (Isso demora um pouco)...";
                    status.innerText = "NÃ£o feche a janela. VÃ­deos sÃ£o pesados.";
                    videoUrl = await upload(videoFile);
                }

                // 4. Salvar no Banco
                btn.innerText = "ðŸ’¾ Salvando no Banco...";
                
                await db.collection('products').add({ 
                    name: name, 
                    price: Number(price), 
                    description: document.getElementById('p-desc').value,
                    imageUrl: coverUrl, // MantÃ©m compatibilidade com Home
                    gallery: galleryUrls, // Nova lista de fotos
                    videoUrl: videoUrl,   // Novo vÃ­deo
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                alert("âœ… Produto Cadastrado com Sucesso!");
                location.reload(); // Recarrega para limpar tudo

            } catch(e) {
                alert("Erro: " + e.message);
                btn.disabled = false;
                btn.innerText = "CADASTRAR PRODUTO";
                status.innerText = "";
            }
        }

        // --- FunÃ§Ãµes Visuais (AparÃªncia) ---
        function setTheme(name, el) {
            document.getElementById('theme-val').value = name;
            document.querySelectorAll('.theme-opt').forEach(d=>d.classList.remove('selected'));
            el.classList.add('selected');
        }
        async function loadData() {
            const doc = await db.collection('cms').doc('layout').get();
            if(doc.exists) {
                const d = doc.data();
                document.getElementById('cms-headline-in').value = d.headline || '';
                document.getElementById('cms-slogan-in').value = d.slogan || '';
                document.getElementById('theme-val').value = d.theme || 'padrao';
            }
        }
        async function saveLayout() {
            // (CÃ³digo de salvar layout igual ao anterior, simplificado aqui)
            const data = { 
                theme: document.getElementById('theme-val').value, 
                headline: document.getElementById('cms-headline-in').value,
                slogan: document.getElementById('cms-slogan-in').value 
            };
            await db.collection('cms').doc('layout').set(data, {merge:true});
            alert("AparÃªncia Salva!");
        }
    </script>
</body>
</html>
